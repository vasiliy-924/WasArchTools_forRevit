# SMART-план: тактика автопостановки розеток 220В в жилье и JSON‑схема правил

Цель: сформировать детерминированные правила и алгоритм, по которым скрипт расставляет только бытовые розетки 220В (BS 1363) в жилых помещениях, соблюдая BS 7671 и проектные эвристики, и описать это правилами в JSON.

## 1) Входные данные, которые должен знать скрипт
- Классификация помещения: `room_type` (living, bedroom, kitchen, corridor, bathroom, wc, utility, etc.).
- Геометрия помещений: контур, стены, высота этажа, отметка чистого пола.
- Проёмы: двери (с откосами), окна, их размеры и положение по стенам.
- Стационарные элементы: кухонные модули/столешницы (высота рабочей поверхности), сантехника, стационарная мебель (если доступно).
- Зоны ванных (701): границы Zone 0/1/2.

## 2) Нормативные ограничения (BS 7671) для геометрии
- Минимальная высота установки аксессуаров: `>= 150 мм` над чистым полом или над рабочей поверхностью (553.1.6 — рекомендация против повреждений).
- Диапазон доступности (строительные нормы Part M/BS 8300): `450–1200 мм` от пола.
- Ванные/душевые (701): розетки (кроме SELV) только на расстоянии `>= 3.0 м` от внешней границы Zone 1. Все цепи — под RCD 30 mA.

## 3) Проектная тактика (детерминируем то, что BS не фиксирует)
Чтобы расстановка была предсказуемой, выбираем «якорные» высоты и правила распределения:

- Базовые «якорные» высоты по типу помещения (центр розетки от пола):
  - living/bedroom/corridor/utility: `250 мм` (низкая якорная высота для удобства мебели и кабелей; не является требованием Part M).
  - kitchen над столешницей: `worktop_height + 150 мм` (чистая надбавка).
  - bathroom/wc: если розетки нужны (например, вне зон) — по общему правилу `450 мм`, но с проверкой `>= 3.0 м` от Zone 1.
- Горизонтальные отступы (проектные эвристики):
  - От внутренних углов стен: `>= 200 мм`.
  - От вертикальных кромок дверных проёмов (наличник/откос): `>= 200 мм`.
  - От вертикальных кромок оконных откосов: `>= 150 мм`.
  - Эти значения не в BS 7671; это «policy» для аккуратной расстановки и избежания конфликтов с наличниками.
- Расчёт количества розеток (project policy):
  - living/bedroom/corridor: `количество = ceil(периметр / 4 м)`.
  - kitchen (над столешницей): минимум `4` для рабочих зон, плюс `ceil(длина активной зоны столешниц / 2.5 м)`.
  - bathroom/wc: по задаче обычно не ставим; если ставим — строго вне зон и по назначению.
  - Примечание: это не BS 7671; это управляемая политика, вынесенная в JSON, чтобы можно было настраивать.
- Распределение по стенам:
  - Стены разбиваются на допустимые сегменты с вычетом зон «запрета» вокруг проёмов и углов по отступам.
  - Розетки равномерно распределяются по допустимым сегментам, начиная с самых длинных стен.
  - Минимальный интервал между розетками по одной стене: `>= 1.2 м` (policy, чтобы не ставить слишком часто).
- Разрешение конфликтов:
  - Если на «якорной» высоте пересечение с объектом (плинтус высокой высоты, короб, сантехника):
    1) Попробовать смещение вдоль стены в пределах сегмента.
    2) Если нельзя — попробовать альтернативные высоты в пределах 250–1200 мм: последовательность `250 → 450 → 600 → 900 → 1200 мм`.
    3) Если всё ещё конфликт — перенести на следующий сегмент стены.

## 4) Алгоритм работы скрипта (пошагово)
1. Для помещения определить `room_type` и собрать «запретные зоны» (проёмы + отступы, сантехника, зоны 701, кухонные фартуки и пр.).
2. Выбрать якорную высоту по `room_type`:
   - general: `250 мм`, kitchen_over_worktop: `worktop + 150 мм`.
3. Посчитать целевое количество розеток для этого `room_type` по текущей политике.
4. Разбить стены на допустимые сегменты (учесть отступы от углов/проёмов и зоны запрета). Сегменты отсортировать по длине (убывание).
5. Равномерно распределить розетки по сегментам, соблюдая минимальный интервал 1.2 м.
6. Для каждой позиции проверить конфликты (пересечение с объектами/оборудованием/зонами):
   - если конфликт — сдвинуть вдоль сегмента; если не вышло — попробовать альтернативные высоты (450→600→900→1200); если не вышло — перенести на следующий сегмент.
7. В ванных: дополнительно проверять расстояние `>= 3.0 м` от границы Zone 1; иначе точку исключать.
8. Выгрузить итоговые точки с метаданными (высота, стена, примечания).

## 5) JSON‑схема правил (предложение)
```json
{
  "metadata": {
    "version": "1.0.0",
    "source": "BS 7671:2008 + project policy",
    "units": "mm"
  },
  "norms": {
    "height_min": 150,
    "accessibility_range": [450, 1200],
    "bathrooms": {
      "zone1_socket_clearance_mm": 3000
    }
  },
  "policy": {
    "heights": {
      "general_anchor_mm": 250,
      "kitchen_over_worktop_offset_mm": 150,
      "alternative_heights_mm": [250, 450, 600, 900, 1200]
    },
    "clearances": {
      "from_inside_corner_mm": 200,
      "from_door_jamb_mm": 200,
      "from_window_jamb_mm": 150
    },
    "min_spacing_on_wall_mm": 1200,
    "count_rules": {
      "living": { "method": "perimeter_divisor", "value_mm": 4000, "min": 2 },
      "bedroom": { "method": "perimeter_divisor", "value_mm": 4000, "min": 2 },
      "corridor": { "method": "perimeter_divisor", "value_mm": 4000, "min": 1 },
      "kitchen": {
        "method": "worktop_based",
        "min": 4,
        "per_length_mm": 2500
      },
      "bathroom": { "method": "none", "min": 0 }
    }
  },
  "room_overrides": {
    "kitchen": {
      "height_rule": "worktop_plus_offset"
    },
    "bathroom": {
      "allow_only_if_ge_3m_from_zone1": true
    }
  },
  "decision_order": {
    "segments_sort": "longest_first",
    "height_try_order_mm": [250, 450, 600, 900, 1200],
    "fallback_segment_policy": "next_segment_then_next_wall"
  }
}
```

## 6) Пример применения (коротко)
- Комната 5×4 м (периметр 18 м), тип `living` → целевое количество: `ceil(18000/4000)=5` точек, высота `250 мм`.
- Учитываем проёмы/углы (отступы 200 мм от углов и дверей), режем стены на сегменты и равномерно раскладываем 5 точек с шагом ≥1.2 м.
- Конфликт? Смещаем по сегменту; если нельзя — пробуем высоты 600/900/1200; если нельзя — переносим в другой сегмент.

## 7) Замечания
- Все «policy»‑параметры (отступы, интервалы, формулы количества) — осознанные эвристики, а не BS 7671. Их можно централизованно менять без правки кода.
- Нормативные проверки (150 мм минимум; 450–1200 мм диапазон; 3.0 м от Zone 1) — жёсткие и неизменяемые в разделе `norms`.

---
Готов расширить JSON‑схему под ваш формат данных Revit/pyRevit (учёты стен, GUID, осей и т.д.) и добавить генерацию «explain»‑поля для каждой точки (почему выбрана такая стена/высота/смещение).
